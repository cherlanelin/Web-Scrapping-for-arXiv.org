---
title: "R Script for Scrapping Paper Information from Archive"
author: "Cherlane"
date: "June 30, 2019"
output: html_document
---

Function "ipak" is a powerful function developed by Yifan Wu, a PhD student from department of statistics and actuarial science. To load all the required packages/library in our analysis, we suggest to run this function at the beginning.
```{r,warning=FALSE,message=FALSE}
# Function Ipak for Detecting and Installing the Packages
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}


# The list/vector with the name of the packages you need in the further analysis coding.
packages <- c("tidyverse",  # General-purpose data wrangling
              "rvest",  # Parsing of HTML/XML files  
              "stringr",    # String manipulation
              "rebus",      # Verbose regular expressions
              "lubridate",   # Eases DateTime manipulation
              "aRxiv",   # Package for communicating to aRvix.org API and get update information
              "RPostgreSQL", # Package for communicating to PostgreSQL
              "RCurl",   
              "rjson")

# Passing the list/vector of package name to the function to check the installation of the packages
ipak(packages)
```

### Function for Getting the information of the newest n-th papers from the total N newest paper 
```{r}
get.nth.paper = function(n,N,webpage){
  if (n>N){
    print("Exceeding the limit N, only give the information of the N-th newest paper ")
    n = N}
  
    webpage.local = webpage
    ## Get the Link of the newest paper
    link=webpage.local%>%html_nodes(paste("#dlpage > dl:nth-child(10) > dt:nth-child(",2*n-1,") > span:nth-child(2) > a:nth-child(1)", sep = ""))%>%html_text
    
    link.make = paste("https://arxiv.org/abs/", substr(link,7,nchar(link)),sep = "")
    
    ## Get All the information of the newest paper
    all= webpage.local%>%html_nodes(paste("#dlpage > dl:nth-child(10) > dd:nth-child(",2*n,") > div:nth-child(1)", sep = ""))%>%html_text
    
    all.clean = unlist(strsplit(all,split='\n\n\n', fixed=TRUE))
  
    all.title = substr(all.clean[1],10,nchar(all.clean[1]))
    
    all.author= str_remove_all(substr(all.clean[2],10,nchar(all.clean[2])), "\n")
    
    all.description = str_remove_all(all.clean[length(all.clean)],"\n")
  
    all.final = data.frame(link = link,
                           link_makeup = link.make,
                           title = all.title,
                           author = all.author,
                           description = all.description)
    return(all.final)
}
```


### Function for getting the information of the N newest paper from arXiv
```{r}
get.all.N.paper = function(N){
  all.N = data.frame(matrix(ncol = 5, nrow = 1))
  colnames(all.N) <- c("link", "link_makeup", 
                       "title", "author", 
                       "description")
  url.local = paste("https://arxiv.org/list/cs/new?skip=0&show=",N,sep="")
  #Reading the HTML code from the website
  webpage.local <- read_html(url.local)
  for (n in 1:N){
     nth.paper = get.nth.paper(n,N,webpage.local)
     all.N = rbind(all.N, nth.paper)
  }
all.N = all.N[-1,]
return(all.N)
}
```


### Function for checking the new publications on a given day
```{r}
get.today.cs.paper = function(){
  format(Sys.Date(), "YYYYMMDD")
  today = Sys.Date()
  today.date = str_remove_all(as.character(today),"-")
  yester.date = str_remove_all(as.character(today-1),"-")
  search.query= paste("submittedDate:[",yester.date,"1231* TO ",today.date,"1230*] AND cat:cs*", sep = "")
  today.num = arxiv_count(search.query)
  if (today.num > 0 ){
  today.paper = get.all.N.paper(today.num)
  return(today.paper)}else{
    print(paste("no new paper has submitted from",today-1,"to",today))
    all.N = data.frame(matrix(ncol = 5, nrow = 1))
    colnames(all.N) <- c("link", "link_makeup", 
                       "title", "author", 
                       "description")
    return(all.N)
  }
}
```



### Connecting to PostgreSQL
```{r}
pg <- dbDriver("PostgreSQL")
con <- dbConnect(pg, host="localhost", user="postgres",password = "aptx0330")
```


### Update Existing Table in PostgreSQL
```{r}
today.paper = get.today.cs.paper()
if ((nrow(na.omit(today.paper))) != 0){
  today.paper = today.paper%>%map_df(rev)
  dbWriteTable(con,'cs_paper_meta', today.paper, append = TRUE, row.names=FALSE)
}
dbDisconnect(con)
```